services:
  db:
    image: mariadb:10.5
    restart: always

    env_file:
      - nextcloudcreds.env

    volumes:
      - db_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW

  app:
    image: nextcloud:latest
    restart: always
    ports:
      - 8080:80
    links:
      - db

    env_file:
      - nextcloudcreds.env

    volumes:
      # ZFS DATASET MAPPING
      - /nas/Family/Phones:/var/www/html/data # NOTE: Corrected from Test to Phones
      - nc_config:/var/www/html/config
      - nc_apps:/var/www/html/apps
    environment:
      # Keep these as they are specific to the Nextcloud app
      - MYSQL_HOST=db
      - NEXTCLOUD_TRUSTED_DOMAINS=192.168.0.127:8080
      - OVERWRITEPROTOCOL=http
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=512M

      # *** We MUST still declare these variables in the 'app' service 
      # but they do not need values here because env_file is present.
      # Wait, let's keep it simple: REMOVE these from the environment 
      # and let the env_file handle everything for a cleaner setup:
      - MYSQL_PASSWORD
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

volumes:
  db_data:
  nc_config:
  nc_apps:

