services:
  db:
    image: mariadb:10.5
    restart: always

    env_file:
      - nextcloudcreds.env # Only the DB service needs the password values loaded this way

    volumes:
      - db_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW

  app:
    image: nextcloud:latest
    restart: always
    ports:
      - 8080:80
    links:
      - db

    volumes:
      - /nas/Family/Phones:/var/www/html/data
      - nc_config:/var/www/html/config # This volume will be clean
      - nc_apps:/var/www/html/apps
    environment:
      # CRITICAL: We tell Nextcloud the DB type and location here, NOT the password.
      - NEXTCLOUD_TRUSTED_DOMAINS=192.168.0.127:8080
      - OVERWRITEPROTOCOL=http
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=512M
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud # Setting the DB user/name directly in the environment

      # Remove all env_file and explicit password variables from 'app'
      # Nextcloud will now run the setup wizard

volumes:
  db_data:
  nc_config:
  nc_apps:
