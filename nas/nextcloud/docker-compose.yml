services:
  db:
    image: mariadb:10.5
    restart: always

    # ðŸ”‘ Uses the local nextcloudcreds.env for passwords (MYSQL_ROOT_PASSWORD, MYSQL_PASSWORD, etc.)
    env_file:
      - nextcloudcreds.env

    volumes:
      - db_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW

  app:
    image: nextcloud:latest
    restart: always
    ports:
      - 8080:80
    env_file:
      - nextcloudcreds.env

    volumes:
      # ðŸ’¾ Updated ZFS DATASET MAPPING
      - /nas/Family/Test:/var/www/html/data   # Changed to /nas/Family/Test
      - nc_config:/var/www/html/config
      - nc_apps:/var/www/html/apps
    environment:
      # These are essential for the application setup
      - NEXTCLOUD_TRUSTED_DOMAINS=192.168.0.127:8080
      - OVERWRITEPROTOCOL=http
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=512M

      # Explicitly set DB connection host (Docker network name)
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

volumes:
  db_data:
  nc_config:
  nc_apps:
