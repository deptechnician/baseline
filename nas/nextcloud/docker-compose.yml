version: '3.8'

services:
  db:
    image: mariadb:10.5
    restart: always

    # Load sensitive credentials from nextcloudcreds.env
    env_file:
      - nextcloudcreds.env

    volumes:
      - db_data:/var/lib/mysql

    # Recommended commands for Nextcloud database
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW

  app:
    image: nextcloud:latest
    restart: always
    ports:
      # Map host port 8080 to container port 80
      - 8080:80

    # Load DB user/password and potentially other env variables
    env_file:
      - nextcloudcreds.env

    volumes:
      # Main user files and storage (swapped /nas/Family/Test for a named volume)
      - nc_data:/var/www/html/data
      # Configuration files (essential)
      - nc_config:/var/www/html/config
      # Nextcloud applications (the apps/ folder)
      - nc_apps:/var/www/html/apps

    environment:
      # Nextcloud installation parameters
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

      # Nextcloud access/network settings
      - NEXTCLOUD_TRUSTED_DOMAINS=192.168.0.127:8080
      - OVERWRITEPROTOCOL=http

      # PHP settings
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=512M

volumes:
  # Database persistence
  db_data:
  # Nextcloud main user data ⬅️ CHANGED TO A NAMED VOLUME
  nc_data:
  # Nextcloud configuration files
  nc_config:
  # Nextcloud installed applications
  nc_apps:
